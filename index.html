<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoTap</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #4ade80, #22c55e);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            user-select: none;
        }

        .game-container {
            text-align: center;
            padding: 20px;
            max-width: 400px;
            width: 100%;
        }

        .stats-panel {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 18px;
        }

        .energy-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            transition: width 0.3s ease;
        }

        .tap-button {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            cursor: pointer;
            transition: transform 0.1s ease;
            margin: 20px auto;
        }

        .tap-button:active {
            transform: scale(0.95);
        }

        .loading {
            opacity: 0.7;
        }

        .status-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }

        .error {
            background: rgba(239, 68, 68, 0.3);
        }

        .success {
            background: rgba(34, 197, 94, 0.3);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="stats-panel">
            <div class="stat-item">
                <span>üí∞ Points:</span>
                <span id="points">0</span>
            </div>
            <div class="stat-item">
                <span>üå≥ Trees:</span>
                <span id="trees">0</span>
            </div>
            <div class="stat-item">
                <span>‚≠ê Level:</span>
                <span id="level">1</span>
            </div>
            <div class="stat-item">
                <span>‚ö° Energy:</span>
                <span id="energy">100/100</span>
            </div>
            <div class="energy-bar">
                <div class="energy-fill" id="energyBar" style="width: 100%"></div>
            </div>
        </div>

        <button class="tap-button" id="tapButton">
            üíß TAP
        </button>

        <div id="statusMessage" class="status-message" style="display: none;"></div>
    </div>

    <script>
        // Telegram WebApp initialization
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // API Configuration
        const API_BASE = 'http://127.0.0.1:8000';
        
        // Game state
        let gameState = {
            points: 0,
            trees: 0,
            level: 1,
            experience: 0,
            energy: 100,
            total_taps: 0
        };

        let isLoading = false;
        let userId = null;

        // Get user ID from Telegram
        function getUserId() {
            if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                return tg.initDataUnsafe.user.id;
            }
            // Fallback for testing
            return Math.floor(Math.random() * 1000000);
        }

        // Update UI
        function updateUI() {
            document.getElementById('points').textContent = gameState.points;
            document.getElementById('trees').textContent = gameState.trees;
            document.getElementById('level').textContent = gameState.level;
            document.getElementById('energy').textContent = `${gameState.energy}/100`;
            
            const energyPercent = (gameState.energy / 100) * 100;
            document.getElementById('energyBar').style.width = `${energyPercent}%`;
            
            const tapButton = document.getElementById('tapButton');
            if (gameState.energy <= 0) {
                tapButton.style.opacity = '0.5';
                tapButton.disabled = true;
            } else {
                tapButton.style.opacity = '1';
                tapButton.disabled = false;
            }
        }

        // Show status message
        function showMessage(message, type = 'success') {
            const messageEl = document.getElementById('statusMessage');
            messageEl.textContent = message;
            messageEl.className = `status-message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }

        // API calls
        async function registerUser() {
            try {
                const userData = tg.initDataUnsafe?.user || {};
                const response = await fetch(`${API_BASE}/api/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        username: userData.username,
                        first_name: userData.first_name,
                        last_name: userData.last_name
                    })
                });
                
                const data = await response.json();
                if (data.progress) {
                    gameState = data.progress;
                    updateUI();
                }
                
                if (data.registered) {
                    showMessage('Welcome to EcoTap!');
                } else {
                    showMessage('Welcome back!');
                }
            } catch (error) {
                console.error('Registration failed:', error);
                showMessage('Failed to connect to server', 'error');
            }
        }

        async function sendTap() {
            if (isLoading || gameState.energy <= 0) return;
            
            isLoading = true;
            const tapButton = document.getElementById('tapButton');
            tapButton.classList.add('loading');
            
            try {
                const response = await fetch(`${API_BASE}/api/tap`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        taps: 1
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    gameState = data;
                    updateUI();
                } else {
                    const error = await response.json();
                    showMessage(error.detail || 'Tap failed', 'error');
                }
            } catch (error) {
                console.error('Tap failed:', error);
                showMessage('Connection error', 'error');
            } finally {
                isLoading = false;
                tapButton.classList.remove('loading');
            }
        }

        async function loadProgress() {
            try {
                const response = await fetch(`${API_BASE}/api/user/${userId}`);
                if (response.ok) {
                    const data = await response.json();
                    gameState = data;
                    updateUI();
                }
            } catch (error) {
                console.error('Failed to load progress:', error);
            }
        }

        // Event listeners
        document.getElementById('tapButton').addEventListener('click', sendTap);

        // Initialize game
        async function initGame() {
            userId = getUserId();
            console.log('User ID:', userId);
            
            await registerUser();
            
            // Sync progress every 30 seconds
            setInterval(loadProgress, 30000);
        }

        // Start game when page loads
        initGame();
    </script>
</body>
</html>
